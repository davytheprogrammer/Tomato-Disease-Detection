<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; max-width: 800px; }
        .debug-info { background: #f0f0f0; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .success { background: #d4edda; border-left-color: #28a745; }
        .upload-area { border: 2px dashed #ccc; padding: 30px; text-align: center; margin: 20px 0; border-radius: 10px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: white; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>üçÖ Tomato Disease Detection - Debug Upload</h1>
    <p>This page helps diagnose upload issues. Try uploading an image and check the output below.</p>
    
    <div class="upload-area">
        <h3>Select Image to Test Upload</h3>
        <form id="debugForm">
            <input type="file" id="imageFile" name="image" accept="image/jpeg,image/jpg,image/png" required>
            <br><br>
            <button type="submit">üöÄ Test Upload</button>
        </form>
    </div>
    
    <div id="fileInfo" class="debug-info hidden">
        <h3>üìÑ File Information:</h3>
        <pre id="fileDetails"></pre>
    </div>
    
    <div id="uploadProgress" class="debug-info hidden">
        <h3>‚è≥ Upload Progress:</h3>
        <div class="progress-bar" style="background: #e9ecef; height: 20px; border-radius: 10px;">
            <div id="progressFill" style="background: #28a745; height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s;"></div>
        </div>
        <p id="progressText">0% - Ready to upload</p>
    </div>
    
    <div id="responseInfo" class="debug-info hidden">
        <h3>üì° Server Response:</h3>
        <pre id="responseDetails"></pre>
    </div>
    
    <div id="errorInfo" class="debug-info error hidden">
        <h3>‚ùå Error Details:</h3>
        <pre id="errorDetails"></pre>
    </div>

    <script>
        // CSRF token from Django
        const CSRF_TOKEN = '{{ csrf_token }}';
        console.log('üîë CSRF Token from template:', CSRF_TOKEN ? 'Yes' : 'No');
        console.log('üç™ CSRF Token from cookies:', getCookie('csrftoken') ? 'Yes' : 'No');
        
        // Debug: Show all cookies
        console.log('üç™ All cookies:', document.cookie);
        
        document.getElementById('debugForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('‚ùå Please select a file first');
                return;
            }
            
            // Show file info
            const fileInfo = {
                filename: file.name,
                size: file.size,
                sizeMB: (file.size / (1024 * 1024)).toFixed(2) + ' MB',
                type: file.type,
                lastModified: new Date(file.lastModified).toLocaleString()
            };
            
            document.getElementById('fileDetails').textContent = JSON.stringify(fileInfo, null, 2);
            document.getElementById('fileInfo').classList.remove('hidden');
            
            // Validate file
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                showError('Invalid file type: ' + file.type + '. Only JPG, JPEG, PNG allowed.');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showError('File too large: ' + fileInfo.sizeMB + '. Maximum 10MB allowed.');
                return;
            }
            
            // Show progress
            document.getElementById('uploadProgress').classList.remove('hidden');
            updateProgress(0, 'Starting upload...');
            
            // Create form data
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                console.log('üöÄ Starting upload to /api/predict/');
                updateProgress(10, 'Connecting to server...');
                
                const xhr = new XMLHttpRequest();
                
                // Progress tracking
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 50);
                        updateProgress(percent, `Uploading... ${percent}%`);
                    }
                });
                
                xhr.addEventListener('loadstart', function() {
                    updateProgress(60, 'Processing image...');
                });
                
                xhr.addEventListener('load', function() {
                    updateProgress(100, 'Complete!');
                    
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            showResponse(response);
                        } catch (e) {
                            showError('Invalid JSON response: ' + xhr.responseText.substring(0, 500));
                        }
                    } else {
                        showError(`Server error ${xhr.status}: ${xhr.statusText}\nResponse: ${xhr.responseText.substring(0, 500)}`);
                    }
                });
                
                xhr.addEventListener('error', function() {
                    showError('Network error during upload. Check connection and server status.');
                });
                
                xhr.addEventListener('timeout', function() {
                    showError('Upload timeout. Server may be overloaded.');
                });
                
                // Simulate processing progress
                let processingProgress = 60;
                const processInterval = setInterval(() => {
                    if (processingProgress < 95) {
                        processingProgress += 5;
                        updateProgress(processingProgress, `Analyzing image... ${processingProgress}%`);
                    }
                }, 200);
                
                xhr.addEventListener('loadend', function() {
                    clearInterval(processInterval);
                });
                
                // Send request
                xhr.open('POST', '/api/predict/');
                xhr.timeout = 30000; // 30 second timeout
                
                // Add CSRF token
                if (CSRF_TOKEN) {
                    xhr.setRequestHeader('X-CSRFToken', CSRF_TOKEN);
                    console.log('üîë CSRF Token added:', CSRF_TOKEN.substring(0, 10) + '...');
                } else {
                    console.warn('‚ö†Ô∏è No CSRF token found');
                }
                
                console.log('üì§ Sending request...');
                xhr.send(formData);
                
            } catch (error) {
                console.error('‚ùå Upload error:', error);
                showError('Upload failed: ' + error.message);
            }
        });
        
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `${percent}% - ${text}`;
        }
        
        function showResponse(response) {
            document.getElementById('responseDetails').textContent = JSON.stringify(response, null, 2);
            document.getElementById('responseInfo').classList.remove('hidden');
            
            if (response.success && response.prediction) {
                const pred = response.prediction;
                const message = `‚úÖ Analysis complete! Detected: ${pred.class} (Confidence: ${pred.confidence.toFixed(1)}%)`;
                showNotification(message, 'success');
                
                // Optionally display results in a more detailed way
                displayResults(response);
            }
        }
        
        function displayResults(response) {
            const pred = response.prediction;
            const isHealthy = pred.class === 'Healthy Plant';
            
            let resultsHtml = `
                <div style="margin-top: 20px; padding: 15px; border-radius: 8px; background: ${isHealthy ? '#d4edda' : '#f8d7da'};">
                    <h4 style="color: ${isHealthy ? '#155724' : '#721c24'};">
                        ${isHealthy ? '‚úÖ Healthy Plant' : '‚ö†Ô∏è ' + pred.class}
                    </h4>
                    <p><strong>Confidence:</strong> ${pred.confidence.toFixed(1)}%</p>
            `;
            
            if (pred.disease_info && pred.disease_info.symptoms) {
                resultsHtml += `
                    <div style="margin-top: 10px;">
                        <strong>Symptoms:</strong> ${pred.disease_info.symptoms}
                    </div>
                `;
            }
            
            if (pred.disease_info && pred.disease_info.interventions && !isHealthy) {
                resultsHtml += `
                    <div style="margin-top: 10px;">
                        <strong>Treatment:</strong> ${pred.disease_info.interventions}
                    </div>
                `;
            }
            
            resultsHtml += '</div>';
            
            document.getElementById('responseInfo').innerHTML += resultsHtml;
        }
        
        function showError(error) {
            document.getElementById('errorDetails').textContent = error;
            document.getElementById('errorInfo').classList.remove('hidden');
            showNotification('‚ùå ' + error, 'error');
        }
        
        function showNotification(message, type) {
            // Simple notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 5px;
                background: ${type === 'error' ? '#dc3545' : '#28a745'}; color: white; z-index: 1000;
                max-width: 300px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
        }
        
        // CSRF token helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Add some helpful info
        console.log('üçÖ Debug upload page loaded');
        console.log('üìã Allowed file types: image/jpeg, image/jpg, image/png');
        console.log('üìè Max file size: 10MB');
        console.log('üåê Endpoint: /api/predict/');
    </script>
</body>
</html>